<div id="users">
<h1>
    Usuarios
</h1>
<div id="tabla_users">
<table >
    <% for (var i in users) { %>
    <tr>
        <td>
            <a href="/users/<%= users[i].id %>" ><%= users[i].username %></a>
            <%= users[i].isAdmin ? "(admin)" : "" %>
        </td>

        <% if (session.user) { %>

            <% if (session.user.isAdmin || session.user.id === users[i].id) { %>
                <td>
                    <a href="/users/<%= users[i].id %>/edit"><button>editar</button></a>
                </td>
            <%  } %>

            <% if (session.user.isAdmin && session.user.id !== users[i].id) { %>
                <td>
                    <a href="/users/<%= users[i].id %>?_method=DELETE"
                       onClick="return confirm('Borrar cuenta: <%= users[i].username %>');">
                        <button>borrar</button>
                    </a>
                </td>
            <%  } %>

        <%  } %>

    </tr>
    <%  } %>
</table>
    <% if (session.user) { %>
    <a href="/users/new"><button type="button">Crear usuario</button></a>
    <%  } %>

</div>


<%if(session.user){%>
<div class="tabla_users_conectados">
            <table>

                <p><b>Usuarios conectados:</b></p>
                <%for(var i in sesiones){%>
                    <tr>
                        <td>
                            <%=sesiones[i].username%>
                        </td>
                    </tr>
                <%}%>
            </table>
</div>
</div>
    <div  id="chat">

        <ul id="messages"></ul>

        <form id="caja-mensaje" onsubmit="return sendMsg(this)" action="">
            <input  type="text" placeholder="Enviar mensaje" id="msg" onfocus="sendTyping()" onblur="sendNoTyping()" required >
            <input id="enviar_msg" type="submit" value="Enviar">
        </form>

    <script>

            var username="<%=session.user.username%>";
            /* Desaparece la notificacion de mensaje nuevo */
            document.getElementById("circulo").style.display='none';


            if(!sessionStorage.conectado){/* Se ha conectado un nuevo usuario */
                 sendNew();/*Envio evento de nuevo usuario*/
                sessionStorage.conectado="<%=session.user.username%>";
            }else{ /* Usuario que ya estaba conectado */
                sendRecord();/* Envio evento de "solicito historial de mensajes" */
            }

            /*Funcion local para enviar un evento cada vez que se conecta un nuevo usuario */
            function sendNew() {
                socket.emit('new',username);
                return false;
            }

            /* Funcion local que envia un mensaje al chat cada vez que se pulsa 'Enviar' */
            function sendMsg(e) {
                var msg={
                    author:"<%=session.user.username%>",
                    text:$('#msg').val()
                };
                socket.emit('noTyping',msg.author);
                socket.emit('chat message', msg);
                $('#msg').val('');
                return false;
            }
            /* Funcion local que envia un mensaje 'escribiendo' */
            function sendTyping() {
                socket.emit('typing',username);
                return false;
            }
            function sendNoTyping() {
                socket.emit('noTyping',username);
                return false;
            }
            /* Funcion local que envia un evento al servidor para que envie el historial de mensajes */
            function sendRecord() {
                socket.emit('recordMessages',username);
                return false;
            }
            /* Se recibe un mensaje del chat */
            socket.on('messages', function(msg){
                if(msg.author==="<%=session.user.username%>"){/* Distinciion de mensajes propios o mensajes de otros usuarios*/
                    $('#messages').append($('<li class="mensaje_propio">').text(msg.text));
                }else {
                    $('#messages').append("<li class='mensaje_ajeno'><strong>"+msg.author+":</strong>"+msg.text+"</li>");
                }
            });
            /* Se recibe una notificación de usuario nuevo */
            socket.on('nuevo',function (username) {
                /*Si el mensaje de 'nuevo' lo recibe otro usuario que estuviera conectado */
                if("<%=session.user.username%>"!==username){
                    $('#messages').append("<li class='conectado'><strong>"+username +" se ha unido</sctrong></li>")/* Usuario_X se ha unido */;
                }
            });

            /* Se recibe una notificación de usuario desconectado */
            socket.on('borrado',function (username) {
                /*Si el mensaje de 'desconectado' lo recibe otro usuario que estuviera conectado */
                if("<%=session.user.username%>"!==username){
                    $('#messages').append("<li class='conectado'><strong>"+username +" se ha desconectado</sctrong></li>")/* Usuario_X se ha unido */;
                }
            });

            /* Se recibe una notificacion de historial */
            socket.on('historial',function (username,mensajes) {
                if("<%=session.user.username%>"===username){/*Si lo recibe el usuario que se ha conectado, mostramos el historial de mensajes */
                    for (var i in mensajes){
                        var msg=mensajes[i];
                        if(msg.author==="<%=session.user.username%>"){
                            $('#messages').append($('<li class="mensaje_propio">').text(msg.text));
                        }else {
                            $('#messages').append("<li class='mensaje_ajeno'><strong>"+msg.author+":</strong>"+msg.text+"</li>");
                        }
                    }
                }
            });
            /* Se recibe una notificacion de usuario 'escribiendo' */
            socket.on('tecleando',function (username) {

                /*Si el mensaje de 'escribiendo' lo recibe otro usuario que estuviera conectado */
                if ("<%= session.user.username %>" !== username) {
                    $('#messages').append("<li class='conectado' id='<%= session.user.username %>'  ><strong>" + username + " está escribiendo </strong></li>")/* Usuario_X se ha unido */;
                }

            });
            /* Se recibe una notificacion de que el usuario ya no esta escribiendo */
            socket.on('dejarTeclear',function (username) {
                /*Si el mensaje lo recibe otro usuario que estuviera conectado */
                if ("<%= session.user.username %>" !== username) {
                    /* Elimino el mensaje :Usuario_X esta escribiendo */
                    document.getElementById("messages").removeChild(document.getElementById("<%= session.user.username %>"));
                }
            });

    </script>
        </div>
<%}%>

